
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="cliref">
<meta name="DC.Title" content="loop-detect eth-loop (VSI View)">
<meta name="DC.subject" content="loop-detect eth-loop (VSI View)">
<meta name="keywords" content="loop-detect eth-loop (VSI View)">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../command/8090/dc_MAC_Flapping-based_Loop_Detection_Configuration_Commands_title.html">
<meta name="DC.Relation" scheme="URI" content="../../command/8090/cmdBdLoopDetect(MFLPOM_ne).html">
<meta name="DC.Relation" scheme="URI" content="../../command/8090/cmdAssistStp(MFLPOM_ne).html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R21C00">
<meta name="DC.Creator" content="">
<meta name="DC.Publisher" content="20220226">
<meta name="Owner" content="SUBSYS_ID_MFLPOM">
<meta name="DC.Creator" content="SUBSYS_ID_MFLPOM">
<meta name="Platform" content="VRP-V800R021C00">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="hKF77426">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_CLIREF_0000001201131132">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../public_sys-resources/commonltr.css">
<link rel="stylesheet" type="text/css" href="../../public_sys-resources/mediaQuery.css">
<script language="javascript" type="text/javascript" src="../../public_sys-resources/browseVersion.js"></script>
<title>loop-detect eth-loop (VSI View)</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_CLIREF_0000001201131132"></a><a name="EN-US_CLIREF_0000001201131132"></a>

<div class="articleBoxWithoutHead">

<h1 class="topicTitle-h1">loop-detect eth-loop (VSI View)</h1>


<div>
<div class="clifunc"><a name="EN-US_CLIREF_0000001201131132__1.3.1"></a><a name="1.3.1"></a><h2 class="sectiontitle">Function</h2>
<div class="clifuncbody">
<p><p>The <b><span class="cmdname">loop-detect eth-loop</span></b> command enables MAC flapping-based loop detection and configures loop detection parameters.</p>
<p>The <b><span class="cmdname">undo loop-detect eth-loop</span></b> command disables the function.</p>
</p>
<p>By default, MAC flapping-based loop detection is disabled.</p>

</div></div>

<div class="cliformat"><a name="EN-US_CLIREF_0000001201131132__1.3.2"></a><a name="1.3.2"></a><h2 class="sectiontitle">Format</h2>
<div class="cliformatbody">
<p><b><span class="cmdname">loop-detect eth-loop loop-times </span></b><i><span class="varname">loop-times</span></i> <strong><span>detect-cycle</span></strong> <i><span class="varname">detect-cycle-time</span></i> <strong><span>cycles</span></strong> <i><span class="varname">cycles</span></i> [ <strong><span>retry-times</span></strong> <i><span class="varname">retry-times</span></i> <strong><span>block-time</span></strong> <i><span class="varname">block-time</span></i> | <strong><span>alarm-only</span></strong> ]</p>

<p><b><span class="cmdname">undo loop-detect eth-loop</span></b></p>

</div></div>

<div class="cliparam"><a name="EN-US_CLIREF_0000001201131132__1.3.3"></a><a name="1.3.3"></a><h2 class="sectiontitle">Parameters</h2>
<div class="cliparambody">
<div class="tableBorder"><table cellpadding="4" cellspacing="0" summary="">
<tr>
<th valign="bottom" align="left" id="mcps1.3.3.1.1.1">Parameter</th>
<th valign="bottom" align="left" id="mcps1.3.3.1.1.2">Description</th>
<th valign="bottom" align="left" id="mcps1.3.3.1.1.3">Value</th>
</tr>
<tr>
<td valign="top" headers="mcps1.3.3.1-type"><strong><span>loop-times</span></strong> <i><span class="varname">loop-times</span></i></td>
<td valign="top" headers="mcps1.3.3.1-desc">
<p><p>Specifies the number of MAC address entry flaps allowed in a detection cycle.</p>
<p>If a device detects more MAC address entry flaps than the number specified by loop-times within the detection cycle specified by detect-cycle-time, the device concludes that a loop has occurred.</p>
<p>When a blocking priority is configured for an interface bound to a VSI, a VLAN or a BD using the loop-detect eth-loop priority priority command:</p>
<p>If priority is 1 and the number of MAC address entry flaps detected in a detect-cycle-time is greater than or equal to the configured loop-times, a loop has occurred.</p>
<p>If priority is greater than 1 and the number of MAC address entry flaps detected in a detect-cycle-time is greater than the configured loop-times, a loop has occurred.</p>
</p>

</td>
<td valign="top" headers="mcps1.3.3.1-value"><p>The value is an integer ranging from 3 to 1000.</p>
</td>
</tr>

<tr>
<td valign="top" headers="mcps1.3.3.1-type"><strong><span>detect-cycle</span></strong> <i><span class="varname">detect-cycle-time</span></i></td>
<td valign="top" headers="mcps1.3.3.1-desc">
<p><p>Specifies a detection cycle.</p>
</p>

</td>
<td valign="top" headers="mcps1.3.3.1-value"><p>The value is an integer ranging from 3 to 30, in seconds.</p>
</td>
</tr>

<tr>
<td valign="top" headers="mcps1.3.3.1-type"><strong><span>cycles</span></strong> <i><span class="varname">cycles</span></i></td>
<td valign="top" headers="mcps1.3.3.1-desc">
<p><p>Specifies the number of detection cycles. If a device detects loops within the consecutive detection cycles, the device blocks an interface or a PW or just reports an alarm.</p>
<p>If cycles cycles is not specified and the device detects MAC address entry flapping for more times than that specified in loop-times within the detection cycle, the device concludes that a loop has occurred. If cycles cycles is specified and the device detects MAC address entry flapping for more times than that specified in loop-times within a detection cycle (the first one) and the consecutive detection cycles specified by cycles, the device concludes that a loop has occurred.</p>
<p>When configuring MAC flapping-based loop detection on multiple devices in a VSI, a VLAN or a BD, specify different values for cycles cycles so that each device blocks an interface or PW in a different detection cycle. This configuration prevents the devices from blocking different interfaces on a loop and avoids the impact on traffic forwarding.</p>
</p>

</td>
<td valign="top" headers="mcps1.3.3.1-value"><p>The value is an integer ranging from 1 to 15.</p>
</td>
</tr>

<tr>
<td valign="top" headers="mcps1.3.3.1-type"><strong><span>retry-times</span></strong> <i><span class="varname">retry-times</span></i></td>
<td valign="top" headers="mcps1.3.3.1-desc">
<p><p>Specifies the number of times when loops are allowed to occur.</p>
<p>After an interface is unblocked, if the number of times when loops occur exceeds retry-times, the interface is blocked permanently.</p>
<p>If neither alarm-only or retry-times is configured, the system blocks an interface or a PW permanently when detecting a loop.</p>
<p>If retry-times is 0, interfaces are not blocked permanently. Instead, the blocking period is doubled each time the interface is blocked, up to a maximum of five times. For example:</p>
<p>In a scenario where detect-cycle-time is 3s, loop-times is 30, cycles is 1, block-time is 10s, and retry-times is 0, if a MAC address of an interface in a VSI, a VLAN or a BD flaps more than 10 times per second within 3s, the interface is blocked for 10s (as specified in block-time), and then recovers. Each subsequent time the interface is blocked, block-time doubles up to a maximum of 320s.</p>
</p>

</td>
<td valign="top" headers="mcps1.3.3.1-value"><p>The value is an integer ranging from 0 to 5.</p>
</td>
</tr>

<tr>
<td valign="top" headers="mcps1.3.3.1-type"><strong><span>block-time</span></strong> <i><span class="varname">block-time</span></i></td>
<td valign="top" headers="mcps1.3.3.1-desc">
<p><p>Specifies the blocking time for interfaces.</p>
</p>

</td>
<td valign="top" headers="mcps1.3.3.1-value"><p>The value is an integer ranging from 10 to 65535, in seconds.</p>
</td>
</tr>

<tr>
<td valign="top" headers="mcps1.3.3.1-type"><strong><span>alarm-only</span></strong></td>
<td valign="top" headers="mcps1.3.3.1-desc">
<p><p>Only alarm when the loop occurs.</p>
</p>

</td>
<td valign="top" headers="mcps1.3.3.1-value"><p>-</p>
</td>
</tr>

</table></div>

</div></div>

<div class="cliview"><a name="EN-US_CLIREF_0000001201131132__1.3.4"></a><a name="1.3.4"></a><h2 class="sectiontitle">Views</h2>
<div class="cliviewbody">
<p>VSI-AUTO view, VSI-BVSI view, VSI-DEFAULT view, VSI-STATIC view</p>

</div></div>

<div class="clidefaultlevel"><a name="EN-US_CLIREF_0000001201131132__1.3.5"></a><a name="1.3.5"></a><h2 class="sectiontitle">Default Level</h2>
<div class="clidefaultlevelbody">
<p>2: Configuration level</p>

</div></div>

<div class="clitasknameandoper"><a name="EN-US_CLIREF_0000001201131132__1.3.6"></a><a name="1.3.6"></a><h2 class="sectiontitle">Task Name and Operations</h2>
<div class="clitasknameandoperbody">
<div class="tableBorder"><table cellpadding="4" cellspacing="0" summary="">
<tr>
<th valign="bottom" align="left" id="mcps1.3.6.1.1.1">Task Name</th>
<th valign="bottom" align="left" id="mcps1.3.6.1.1.2">Operations</th>
</tr>
<tr>
<td valign="top" headers="mcps1.3.6.1-type">mflp</td>
<td valign="top" headers="mcps1.3.6.1-value">write</td>
</tr>

</table></div>

</div></div>

<div class="clidesc"><a name="EN-US_CLIREF_0000001201131132__1.3.7"></a><a name="1.3.7"></a><h2 class="sectiontitle">Usage Guidelines</h2>
<div class="clidescbody">
<p><strong>Usage Scenario</strong></p>
<p>When CEs are dual-homed to a virtual private LAN service (VPLS) network or primary and secondary pseudo wires (PWs) exist on the network, loops may occur, causing broadcast storms. In this situation, you can run the loop-detect eth-loop command to configure MAC flapping-based loop detection on devices of the VPLS network. When detecting a loop, a device blocks an AC-side interface or a PW to avoid broadcast storms.<p></p>
retry-times retry-times and block-time block-time must both be specified. For example, retry-times is specified as 2 and block-time as 100s. When detecting loops in the VSI, the device blocks interfaces using the following methods:<p></p>
1.When detecting a loop on an interface for the first time, the device keeps the interface blocked for 100s.<p></p>
2.During the first detection cycle (specified by detect-cycle-time) after the first blocking period ends (the blocked interface recovers), if the device detects a loop, it keeps the interface blocked for 2 x 100s.<p></p>
3.During the second detection cycle (specified by detect-cycle-time) after the second blocking period ends, if the device detects a loop, it keeps the interface blocked for 4 x 100s.<p></p>
4.During the third detection cycle (specified by detect-cycle-time) after the third blocking period ends, if the device detects a loop, it keeps the interface blocked permanently. The reason for the permanent blocking is that three loops occur after the first blocking period ends, which exceeds the maximum number of loops specified by retry-times.<p></p>
5.If no loops are detected during detect-cycle-time*30, the blocking count is cleared. If a loop is detected later block-time is restored.</p>
<p><strong>Configuration Impact</strong></p>
<p>After MAC flapping-based loop detection is configured on a device and the device receives packets with forged source MAC addresses from attackers, the device may incorrectly conclude that a loop has occurred and block an interface based on the configured blocking policy. As a result, traffic destined for the interface is affected.</p>
<p><strong>Precautions</strong></p>
<p>When MAC flapping-based loop detection works with the Spanning Tree Protocol (STP), they may take effect at the same time. Traffic is interrupted when they block different interfaces. By default, MAC flapping-based loop detection cannot work with the Spanning Tree Protocol (STP) on devices except when the loop-detect eth-loop assist-stp enable command is configured in the system view.<p></p>
After the loop-detect eth-loop loop-times loop-times detect-cycle detect-cycle-time command is run to enable MAC flapping-based loop detection, the upstream interface board learns MAC addresses. In the configured detection period, if the loop-times or detect-cycle-time parameter is modified, the previous statistics are cleared. Number of times that MAC flapping occurs is re-collected.<p></p>
After MAC flapping-based loop detection is configured on a device and the device receives packets with fake source MAC addresses from attackers, the device may mistakenly conclude that a loop has occurred and block an interface based on the configured blocking policy. Therefore, key user traffic may be blocked. It is recommended that you disable MAC flapping-based loop detection on properly running devices. If you have to use MAC flapping-based loop detection to detect whether links operate properly during site deployment, be sure to disable this function after this stage.<p></p>
Each time when the system detects a loop, the system records a log and reports an alarm to the NMS.<p></p>
A maximum of 32 sub-interfaces can be blocked in the same a VSI.<p></p>
If a blocking priority for MAC flapping-based loop detection is configured on an interface bound to a VSI, a VLAN or a BD using the loop-detect eth-loop priority priority command, the detection cycle is as follows:</p>

<ul><li>If priority is 1, the detection cycle is calculated as follows: Detection cycle = 1 x detect-cycle-time × cycles</li><li>If priority is 2, the detection cycle is calculated as follows: Detection cycle = 4 x detect-cycle-time × cycles</li><li>If priority is 3, the detection cycle is calculated as follows: Detection cycle = 8 x detect-cycle-time × cycles</li><li>If priority is 4, the interface is never blocked, and the MAC flapping-based loop detection function does not take effect.<p></p>
High-priority interfaces have a longer detection time, and low-priority interfaces are preferentially blocked if the MAC flapping based-loop detection function detects a loop.<p></p>
If MAC flapping-based loop detection and VPLS multi-homing (VPLS multi-homing enables data packets to be blocked on the backup PE's AC interface, preventing loops) have been deployed, the AC interfaces of both the master and backup PEs may be blocked because the backup PE's AC interface does not block Layer 2 protocol packets.</li></ul>

</div></div>

<div class="cliexample"><a name="EN-US_CLIREF_0000001201131132__1.3.8"></a><a name="1.3.8"></a><h2 class="sectiontitle">Example</h2>
<div class="cliexamplebody">

<div class="p"># Configure MAC flapping-based loop detection in a VSI.<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>mpls lsr-id 1.1.1.1</strong>
[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>mpls</strong>
[<span class="keyword">*</span><span class="keyword">HUAWEI</span>-mpls] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>mpls l2vpn</strong>
[<span class="keyword">*</span><span class="keyword">HUAWEI</span>-l2vpn] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>vsi company1</strong>
[<span class="keyword">*</span><span class="keyword">HUAWEI</span>-vsi-company1] <strong>loop-detect eth-loop loop-times 3 detect-cycle 10 cycles 3</strong>
</pre>
</div>

</div></div>

</div>


</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../command/8090/dc_MAC_Flapping-based_Loop_Detection_Configuration_Commands_title.html">MAC Flapping-based Loop Detection Configuration Commands
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="copyrightBottomBar_responsive">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../command/8090/cmdBdLoopDetect(MFLPOM_ne).html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../command/8090/cmdAssistStp(MFLPOM_ne).html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>